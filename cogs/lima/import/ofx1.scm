(require "srfi/srfi-28/format.scm")
(require "lima/types.scm")
(require "lima/list.scm")
(require "lima/alist.scm")
(require "lima/import/prelude.scm")
(require "lima/import/types.scm")

(define (convert imp base-account other-account)
  (let* ((hdr (imported-header imp))
         (cur (cdr-assoc-or-default "curdef" "USD" hdr))
         (fields (imported-fields imp))
         (dtposted-i (list-index fields "dtposted"))
         (trnamt-i (list-index fields "trnamt"))
         (fitid-i (list-index fields "fitid"))
         (name-i (list-index fields "name"))
         (memo-i (list-index fields "memo"))
         (acctid (cdr-assoc-or-default "acctid" "unknown-acctid" hdr)))
    (map (lambda (txn)
          (let* ((date (parse-date(list-ref txn dtposted-i) "%Y%m%d"))
                 (name (list-ref txn name-i))
                 (memo (list-ref txn memo-i))
                 (fitid (list-ref txn fitid-i))
                 (amt (parse-decimal (list-ref txn trnamt-i)))
                 (txnid (format "~a.~a" acctid fitid)))
            (transaction date name memo (amount amt cur) base-account (list other-account))))
      (imported-transactions imp))))

(define converted (convert *imported* "Assets:Bank" "Expenses:Unknown"))
